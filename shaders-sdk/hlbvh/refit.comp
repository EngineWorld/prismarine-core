#version 450

#include "../include/constants.glsl"
#include "../include/structs.glsl"
#include "../include/uniforms.glsl"
#include "./includes.glsl"

bbox bboxunion(in bbox b1, in bbox b2) {
    bbox res = b1;
    res.mn = min(res.mn, b2.mn);
    res.mx = max(res.mx, b2.mx);
    return res;
}

void main() {
    const int globalID = int(gl_GlobalInvocationID.x);
    if (globalID >= GEOMETRY_BLOCK geometryUniform.triangleCount) return;

    int idx = Leafs[globalID].parent;
    for(int i=0;i<256;i++) {
        idx = Nodes[idx].parent;
        if (atomicCompSwap(Flags[idx], 0, 1) == 1) {
            const int lc = Nodes[idx].range.x;
            const int rc = Nodes[idx].range.y;
            bbox lb = Nodes[lc].box;
            bbox rb = Nodes[rc].box;
            Nodes[idx].box = bboxunion(lb, rb);
        } else {
            break;
        }
        if (idx <= 0) break;
    }
}
